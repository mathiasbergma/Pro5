\hypertarget{_n_b___r410_m_8h_source}{}\doxysection{NB\+\_\+\+R410\+M.\+h}
\label{_n_b___r410_m_8h_source}\index{src/NB\_R410M.h@{src/NB\_R410M.h}}
\mbox{\hyperlink{_n_b___r410_m_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 }
\DoxyCodeLine{30 \textcolor{preprocessor}{\#include <Arduino.h>}}
\DoxyCodeLine{31 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_a_t__commands_8h}{AT\_commands.h}}"{}}}
\DoxyCodeLine{32 \textcolor{preprocessor}{\#include <HardwareSerial.h>}}
\DoxyCodeLine{33 \textcolor{preprocessor}{\#include "{}SPIFFS.h"{}}}
\DoxyCodeLine{34 }
\DoxyCodeLine{35 HardwareSerial lteSerial(2);}
\DoxyCodeLine{36 }
\DoxyCodeLine{37 \textcolor{preprocessor}{\#define SerialMonitor Serial}}
\DoxyCodeLine{38 \textcolor{preprocessor}{\#define LTEShieldSerial lteSerial}}
\DoxyCodeLine{39 }
\DoxyCodeLine{44 \textcolor{keywordtype}{void} \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} *text)}
\DoxyCodeLine{45 \{}
\DoxyCodeLine{46   SerialMonitor.print(text);}
\DoxyCodeLine{47 \}}
\DoxyCodeLine{48 }
\DoxyCodeLine{53 \textcolor{keywordtype}{void} \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} *command)}
\DoxyCodeLine{54 \{}
\DoxyCodeLine{55   \textcolor{comment}{// printToConsole("{}Command: \%s\(\backslash\)n"{}, command);}}
\DoxyCodeLine{56   \textcolor{comment}{//  Empty the serial buffer}}
\DoxyCodeLine{57   \textcolor{keywordflow}{while} (LTEShieldSerial.available())}
\DoxyCodeLine{58   \{}
\DoxyCodeLine{59     LTEShieldSerial.read();}
\DoxyCodeLine{60   \}}
\DoxyCodeLine{61   \textcolor{comment}{// Transmit the command}}
\DoxyCodeLine{62   LTEShieldSerial.print(command);}
\DoxyCodeLine{63   LTEShieldSerial.print(\textcolor{stringliteral}{"{}\(\backslash\)r"{}});}
\DoxyCodeLine{64 \}}
\DoxyCodeLine{65 }
\DoxyCodeLine{72 \textcolor{keywordtype}{int} \mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} *response, \textcolor{keywordtype}{int} timeout)}
\DoxyCodeLine{73 \{}
\DoxyCodeLine{74   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} timeIn = millis();}
\DoxyCodeLine{75   \textcolor{keywordtype}{char} ret[128];}
\DoxyCodeLine{76   \textcolor{keywordtype}{int} destIndex = 0;}
\DoxyCodeLine{77   \textcolor{keywordtype}{int} index = 0;}
\DoxyCodeLine{78   \textcolor{keywordtype}{char} c;}
\DoxyCodeLine{79   \textcolor{keywordtype}{int} size = strlen(response);}
\DoxyCodeLine{80 }
\DoxyCodeLine{81   \textcolor{keywordflow}{while} (millis() -\/ timeIn < timeout)}
\DoxyCodeLine{82   \{}
\DoxyCodeLine{83     \textcolor{keywordflow}{if} (LTEShieldSerial.available())}
\DoxyCodeLine{84     \{}
\DoxyCodeLine{85       c = (char)LTEShieldSerial.read();}
\DoxyCodeLine{86       \textcolor{comment}{//Serial.print(c);}}
\DoxyCodeLine{87       ret[destIndex++] = c;}
\DoxyCodeLine{88 }
\DoxyCodeLine{89       \textcolor{keywordflow}{if} (c == response[index])}
\DoxyCodeLine{90       \{}
\DoxyCodeLine{91         index++;}
\DoxyCodeLine{92         \textcolor{keywordflow}{if} (index == size)}
\DoxyCodeLine{93         \{}
\DoxyCodeLine{94           \textcolor{keywordflow}{return} 1;}
\DoxyCodeLine{95         \}}
\DoxyCodeLine{96       \}}
\DoxyCodeLine{97       \textcolor{keywordflow}{else}}
\DoxyCodeLine{98       \{}
\DoxyCodeLine{99         index = 0;}
\DoxyCodeLine{100       \}}
\DoxyCodeLine{101     \}}
\DoxyCodeLine{102   \}}
\DoxyCodeLine{103   ret[destIndex] = \textcolor{charliteral}{'\(\backslash\)0'};}
\DoxyCodeLine{104   \textcolor{comment}{//Serial.println(ret);}}
\DoxyCodeLine{105   \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{106 \}}
\DoxyCodeLine{107 }
\DoxyCodeLine{113 \textcolor{keywordtype}{int} \mbox{\hyperlink{_n_b___r410_m_8h_a66f862d5c7d16623b90ccf294c1cf055}{initModule}}(\textcolor{keywordtype}{int} timeout)}
\DoxyCodeLine{114 \{}
\DoxyCodeLine{115   LTEShieldSerial.begin(115200);}
\DoxyCodeLine{116   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} startTime = millis();}
\DoxyCodeLine{117   }
\DoxyCodeLine{118   \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Transmitting AT\(\backslash\)n"{}});}
\DoxyCodeLine{119   \textcolor{keywordflow}{while} (!\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(\textcolor{stringliteral}{"{}OK"{}}, 500))}
\DoxyCodeLine{120   \{}
\DoxyCodeLine{121     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}."{}});}
\DoxyCodeLine{122     \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(\textcolor{stringliteral}{"{}AT"{}}); \textcolor{comment}{// Send AT command to enable the interface}}
\DoxyCodeLine{123     }
\DoxyCodeLine{124     \textcolor{keywordflow}{if} (millis() -\/ startTime > timeout)}
\DoxyCodeLine{125     \{}
\DoxyCodeLine{126       \textcolor{keywordflow}{return} 1;}
\DoxyCodeLine{127     \}}
\DoxyCodeLine{128   \}}
\DoxyCodeLine{129   \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Got OK\(\backslash\)n"{}});}
\DoxyCodeLine{130 }
\DoxyCodeLine{131   \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Disabling echo\(\backslash\)n"{}});}
\DoxyCodeLine{132   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(\textcolor{stringliteral}{"{}ATE0"{}}); \textcolor{comment}{// Disable echo}}
\DoxyCodeLine{133   \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(\textcolor{stringliteral}{"{}OK"{}}, 200))}
\DoxyCodeLine{134   \{}
\DoxyCodeLine{135     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Echo disabled\(\backslash\)n"{}});}
\DoxyCodeLine{136   \}}
\DoxyCodeLine{137   \textcolor{keywordflow}{else}}
\DoxyCodeLine{138   \{}
\DoxyCodeLine{139     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Echo not disabled\(\backslash\)n"{}});}
\DoxyCodeLine{140   \}}
\DoxyCodeLine{141 }
\DoxyCodeLine{142   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(\textcolor{stringliteral}{"{}AT+CTZU=1"{}}); \textcolor{comment}{// Enable automatic time zone update}}
\DoxyCodeLine{143   \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(\textcolor{stringliteral}{"{}OK"{}}, 5000))}
\DoxyCodeLine{144   \{}
\DoxyCodeLine{145     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Automatic time zone update enabled\(\backslash\)n"{}});}
\DoxyCodeLine{146   \}}
\DoxyCodeLine{147   \textcolor{keywordflow}{else}}
\DoxyCodeLine{148   \{}
\DoxyCodeLine{149     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Automatic time zone update not enabled\(\backslash\)n"{}});}
\DoxyCodeLine{150   \}}
\DoxyCodeLine{151 }
\DoxyCodeLine{152   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(\textcolor{stringliteral}{"{}AT+UGPIOC=16,2"{}}); \textcolor{comment}{// Set GPIO16 to indicate network status}}
\DoxyCodeLine{153   \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(\textcolor{stringliteral}{"{}OK"{}}, 5000))}
\DoxyCodeLine{154   \{}
\DoxyCodeLine{155     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}GPIO16 set to indicate network status\(\backslash\)n"{}});}
\DoxyCodeLine{156   \}}
\DoxyCodeLine{157   \textcolor{keywordflow}{else}}
\DoxyCodeLine{158   \{}
\DoxyCodeLine{159     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}GPIO16 not set to indicate network status\(\backslash\)n"{}});}
\DoxyCodeLine{160   \}}
\DoxyCodeLine{161 }
\DoxyCodeLine{162   \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{163 \}}
\DoxyCodeLine{169 \textcolor{keywordtype}{int} \mbox{\hyperlink{_n_b___r410_m_8h_a45ea19fd14a7f7c3d7803940c809dec8}{enableSSL}}(\textcolor{keywordtype}{int} profile)}
\DoxyCodeLine{170 \{}
\DoxyCodeLine{171   \textcolor{keywordtype}{int} returnVal = 1;}
\DoxyCodeLine{172   \textcolor{keywordtype}{char} *command = NULL;}
\DoxyCodeLine{173   command = (\textcolor{keywordtype}{char} *)malloc(strlen(AT) + strlen(SARA\_MQTT\_SECURE) + 5);}
\DoxyCodeLine{174   \textcolor{keywordflow}{if} (command == NULL)}
\DoxyCodeLine{175   \{}
\DoxyCodeLine{176     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Malloc failed"{}});}
\DoxyCodeLine{177     \textcolor{keywordflow}{return} 2;}
\DoxyCodeLine{178   \}}
\DoxyCodeLine{179 }
\DoxyCodeLine{180   sprintf(command, \textcolor{stringliteral}{"{}\%s\%s\%d"{}}, AT, SARA\_MQTT\_SECURE, profile);}
\DoxyCodeLine{181   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(command);}
\DoxyCodeLine{182   \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(SARA\_MQTT\_SECURE\_SET\_RESPONSE, 5000))}
\DoxyCodeLine{183   \{}
\DoxyCodeLine{184     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}SSL enabled"{}});}
\DoxyCodeLine{185     returnVal = 0;}
\DoxyCodeLine{186   \}}
\DoxyCodeLine{187   \textcolor{keywordflow}{else}}
\DoxyCodeLine{188   \{}
\DoxyCodeLine{189     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}SSL not enabled"{}});}
\DoxyCodeLine{190     returnVal = 1;}
\DoxyCodeLine{191   \}}
\DoxyCodeLine{192   free(command);}
\DoxyCodeLine{193   \textcolor{keywordflow}{return} returnVal;}
\DoxyCodeLine{194 \}}
\DoxyCodeLine{195 }
\DoxyCodeLine{203 \textcolor{keywordtype}{int} \mbox{\hyperlink{_n_b___r410_m_8h_a2b3052c267ca2e25a73b972c5dead26b}{assignCert}}(\textcolor{keywordtype}{int} profile, \textcolor{keyword}{const} \textcolor{keywordtype}{char} *certName, \textcolor{keywordtype}{int} certType)}
\DoxyCodeLine{204 \{}
\DoxyCodeLine{205   \textcolor{keywordtype}{int} returnVal = 1;}
\DoxyCodeLine{206   \textcolor{keywordtype}{char} *command = NULL;}
\DoxyCodeLine{207   command = (\textcolor{keywordtype}{char} *)malloc(strlen(AT) + strlen(SARA\_SECURITY\_PROFILE) + strlen(certName) + 10);}
\DoxyCodeLine{208   \textcolor{keywordflow}{if} (command == NULL)}
\DoxyCodeLine{209   \{}
\DoxyCodeLine{210     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Malloc failed"{}});}
\DoxyCodeLine{211     \textcolor{keywordflow}{return} 2;}
\DoxyCodeLine{212   \}}
\DoxyCodeLine{213   sprintf(command, \textcolor{stringliteral}{"{}\%s\%s\%d,\%d,\(\backslash\)"{}\%s\(\backslash\)"{}"{}}, AT, SARA\_SECURITY\_PROFILE, profile, certType, certName);}
\DoxyCodeLine{214   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(command);}
\DoxyCodeLine{215   \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(\textcolor{stringliteral}{"{}OK"{}},1000))}
\DoxyCodeLine{216   \{}
\DoxyCodeLine{217     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Certificate ["{}});}
\DoxyCodeLine{218     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(certName);}
\DoxyCodeLine{219     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}] assigned\(\backslash\)n"{}});}
\DoxyCodeLine{220     returnVal = 0;}
\DoxyCodeLine{221   \}}
\DoxyCodeLine{222   \textcolor{keywordflow}{else}}
\DoxyCodeLine{223   \{}
\DoxyCodeLine{224     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Certificate ["{}});}
\DoxyCodeLine{225     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(certName);}
\DoxyCodeLine{226     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}] not assigned\(\backslash\)n"{}});}
\DoxyCodeLine{227     returnVal = 1;}
\DoxyCodeLine{228   \}}
\DoxyCodeLine{229   free(command);}
\DoxyCodeLine{230   \textcolor{keywordflow}{return} returnVal;}
\DoxyCodeLine{231 \}}
\DoxyCodeLine{232 }
\DoxyCodeLine{236 \textcolor{keywordtype}{void} \mbox{\hyperlink{_n_b___r410_m_8h_aa6f75e9b70b0ada28fb438225a155bbb}{getNetwork}}()}
\DoxyCodeLine{237 \{}
\DoxyCodeLine{238   \textcolor{keywordtype}{int} retval;}
\DoxyCodeLine{239   \textcolor{keywordtype}{int} last = 99;}
\DoxyCodeLine{240   \textcolor{keywordflow}{while} (retval != 1)}
\DoxyCodeLine{241   \{}
\DoxyCodeLine{242 }
\DoxyCodeLine{243     \textcolor{comment}{// Empty the serial buffer}}
\DoxyCodeLine{244     \textcolor{keywordflow}{while} (LTEShieldSerial.available())}
\DoxyCodeLine{245     \{}
\DoxyCodeLine{246       LTEShieldSerial.read();}
\DoxyCodeLine{247     \}}
\DoxyCodeLine{248     \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(\textcolor{stringliteral}{"{}AT+CEREG?"{}});}
\DoxyCodeLine{249     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} timeIn = millis();}
\DoxyCodeLine{250     \textcolor{keywordtype}{char} ret[128];}
\DoxyCodeLine{251     \textcolor{keywordtype}{int} destIndex = 0;}
\DoxyCodeLine{252     \textcolor{keywordtype}{int} index = 0;}
\DoxyCodeLine{253     \textcolor{keywordtype}{char} c;}
\DoxyCodeLine{254     \textcolor{keywordtype}{int} size = 12;}
\DoxyCodeLine{255     retval = 4;}
\DoxyCodeLine{256 }
\DoxyCodeLine{257     \textcolor{keywordflow}{while} (millis() -\/ timeIn < 1000)}
\DoxyCodeLine{258     \{}
\DoxyCodeLine{259       \textcolor{keywordflow}{if} (LTEShieldSerial.available())}
\DoxyCodeLine{260       \{}
\DoxyCodeLine{261         c = (char)LTEShieldSerial.read();}
\DoxyCodeLine{262         \textcolor{comment}{// Serial.print(c);}}
\DoxyCodeLine{263         ret[index++] = c;}
\DoxyCodeLine{264         \textcolor{comment}{// printToConsole("{}index: \%d\(\backslash\)n"{}, index);}}
\DoxyCodeLine{265         \textcolor{keywordflow}{if} (index > size)}
\DoxyCodeLine{266         \{}
\DoxyCodeLine{267           \textcolor{keywordflow}{break};}
\DoxyCodeLine{268         \}}
\DoxyCodeLine{269       \}}
\DoxyCodeLine{270     \}}
\DoxyCodeLine{271     ret[++index] = 0;}
\DoxyCodeLine{272     \textcolor{comment}{// printToConsole("{}ret: \%s\(\backslash\)n"{}, ret);}}
\DoxyCodeLine{273     sscanf(ret, \textcolor{stringliteral}{"{} +CEREG: 0,\%d"{}}, \&retval);}
\DoxyCodeLine{274     \textcolor{keywordflow}{switch} (retval)}
\DoxyCodeLine{275     \{}
\DoxyCodeLine{276     \textcolor{keywordflow}{case} 0:}
\DoxyCodeLine{277       \textcolor{keywordflow}{if} (last != retval)}
\DoxyCodeLine{278       \{}
\DoxyCodeLine{279         \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Not registered, MT is not currently searching a new operator to register to\(\backslash\)n"{}});}
\DoxyCodeLine{280         last = retval;}
\DoxyCodeLine{281       \}}
\DoxyCodeLine{282       \textcolor{keywordflow}{else}}
\DoxyCodeLine{283       \{}
\DoxyCodeLine{284         \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}."{}});}
\DoxyCodeLine{285       \}}
\DoxyCodeLine{286       \textcolor{keywordflow}{break};}
\DoxyCodeLine{287     \textcolor{keywordflow}{case} 1:}
\DoxyCodeLine{288       \textcolor{keywordflow}{if} (last != retval)}
\DoxyCodeLine{289       \{}
\DoxyCodeLine{290         \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Registered, home network\(\backslash\)n"{}});}
\DoxyCodeLine{291         last = retval;}
\DoxyCodeLine{292       \}}
\DoxyCodeLine{293       \textcolor{keywordflow}{else}}
\DoxyCodeLine{294       \{}
\DoxyCodeLine{295         \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}."{}});}
\DoxyCodeLine{296       \}}
\DoxyCodeLine{297       \textcolor{keywordflow}{break};}
\DoxyCodeLine{298     \textcolor{keywordflow}{case} 2:}
\DoxyCodeLine{299       \textcolor{keywordflow}{if} (last != retval)}
\DoxyCodeLine{300       \{}
\DoxyCodeLine{301         \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Scanning for network\(\backslash\)n"{}});}
\DoxyCodeLine{302         last = retval;}
\DoxyCodeLine{303       \}}
\DoxyCodeLine{304       \textcolor{keywordflow}{else}}
\DoxyCodeLine{305       \{}
\DoxyCodeLine{306         \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}."{}});}
\DoxyCodeLine{307       \}}
\DoxyCodeLine{308       \textcolor{keywordflow}{break};}
\DoxyCodeLine{309     \textcolor{keywordflow}{case} 3:}
\DoxyCodeLine{310       \textcolor{keywordflow}{if} (last != retval)}
\DoxyCodeLine{311       \{}
\DoxyCodeLine{312         \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Registration denied\(\backslash\)n"{}});}
\DoxyCodeLine{313         last = retval;}
\DoxyCodeLine{314       \}}
\DoxyCodeLine{315       \textcolor{keywordflow}{else}}
\DoxyCodeLine{316       \{}
\DoxyCodeLine{317         \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}."{}});}
\DoxyCodeLine{318       \}}
\DoxyCodeLine{319       \textcolor{keywordflow}{break};}
\DoxyCodeLine{320     \textcolor{keywordflow}{case} 4:}
\DoxyCodeLine{321       \textcolor{keywordflow}{if} (last != retval)}
\DoxyCodeLine{322       \{}
\DoxyCodeLine{323         \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Unknown\(\backslash\)n"{}});}
\DoxyCodeLine{324         last = retval;}
\DoxyCodeLine{325       \}}
\DoxyCodeLine{326       \textcolor{keywordflow}{else}}
\DoxyCodeLine{327       \{}
\DoxyCodeLine{328         \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}."{}});}
\DoxyCodeLine{329       \}}
\DoxyCodeLine{330       \textcolor{keywordflow}{break};}
\DoxyCodeLine{331     \textcolor{keywordflow}{case} 5:}
\DoxyCodeLine{332       \textcolor{keywordflow}{if} (last != retval)}
\DoxyCodeLine{333       \{}
\DoxyCodeLine{334         \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Registered, roaming\(\backslash\)n"{}});}
\DoxyCodeLine{335         last = retval;}
\DoxyCodeLine{336       \}}
\DoxyCodeLine{337       \textcolor{keywordflow}{else}}
\DoxyCodeLine{338       \{}
\DoxyCodeLine{339         \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}."{}});}
\DoxyCodeLine{340       \}}
\DoxyCodeLine{341       \textcolor{keywordflow}{break};}
\DoxyCodeLine{342     \textcolor{keywordflow}{default}:}
\DoxyCodeLine{343       \textcolor{keywordflow}{if} (last != retval)}
\DoxyCodeLine{344       \{}
\DoxyCodeLine{345         \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Unknown\(\backslash\)n"{}});}
\DoxyCodeLine{346         last = retval;}
\DoxyCodeLine{347       \}}
\DoxyCodeLine{348       \textcolor{keywordflow}{else}}
\DoxyCodeLine{349       \{}
\DoxyCodeLine{350         \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}."{}});}
\DoxyCodeLine{351       \}}
\DoxyCodeLine{352       \textcolor{keywordflow}{break};}
\DoxyCodeLine{353     \}}
\DoxyCodeLine{354     delay(500);}
\DoxyCodeLine{355   \}}
\DoxyCodeLine{356 \}}
\DoxyCodeLine{357 }
\DoxyCodeLine{363 \textcolor{keywordtype}{int} \mbox{\hyperlink{_n_b___r410_m_8h_a155d2d05c4cd7202d2ccec3c482f5e90}{setAPN}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} *apn)}
\DoxyCodeLine{364 \{}
\DoxyCodeLine{365   \textcolor{keywordtype}{int} result = 0;}
\DoxyCodeLine{366   \textcolor{keywordtype}{char} *command = NULL;}
\DoxyCodeLine{367   command = (\textcolor{keywordtype}{char} *)malloc(strlen(AT) + strlen(SARA\_SET\_APN) + strlen(apn) + 5);}
\DoxyCodeLine{368   \textcolor{keywordflow}{if} (command == NULL)}
\DoxyCodeLine{369   \{}
\DoxyCodeLine{370     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Malloc failed"{}});}
\DoxyCodeLine{371     \textcolor{keywordflow}{return} 1;}
\DoxyCodeLine{372   \}}
\DoxyCodeLine{373 }
\DoxyCodeLine{374   sprintf(command, \textcolor{stringliteral}{"{}\%s\%s\(\backslash\)"{}\%s\(\backslash\)"{}"{}}, AT, SARA\_SET\_APN, apn);}
\DoxyCodeLine{375   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(command);}
\DoxyCodeLine{376   \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(\textcolor{stringliteral}{"{}OK"{}}, 1000))}
\DoxyCodeLine{377   \{}
\DoxyCodeLine{378     Serial.println(\textcolor{stringliteral}{"{}APN set"{}});}
\DoxyCodeLine{379     result = 0;}
\DoxyCodeLine{380   \}}
\DoxyCodeLine{381   \textcolor{keywordflow}{else}}
\DoxyCodeLine{382   \{}
\DoxyCodeLine{383     Serial.println(\textcolor{stringliteral}{"{}APN not set"{}});}
\DoxyCodeLine{384   \}}
\DoxyCodeLine{385   free(command);}
\DoxyCodeLine{386   \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{387 \}}
\DoxyCodeLine{388 }
\DoxyCodeLine{393 \textcolor{keywordtype}{char} *\mbox{\hyperlink{_n_b___r410_m_8h_a59fb44183e4857c7b1fa0db81abe59f2}{printInfo}}()}
\DoxyCodeLine{394 \{}
\DoxyCodeLine{395   \textcolor{keywordtype}{char} *ip = NULL;}
\DoxyCodeLine{396   \textcolor{keywordtype}{char} *command = NULL;}
\DoxyCodeLine{397   command = (\textcolor{keywordtype}{char} *)malloc(strlen(AT) + strlen(SARA\_NETWORK\_INFO\_GET) + 5);}
\DoxyCodeLine{398   ip = (\textcolor{keywordtype}{char} *)malloc(16);}
\DoxyCodeLine{399   \textcolor{keywordflow}{if} (ip == NULL)}
\DoxyCodeLine{400   \{}
\DoxyCodeLine{401     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Malloc failed"{}});}
\DoxyCodeLine{402     \textcolor{keywordflow}{return} NULL;}
\DoxyCodeLine{403   \}}
\DoxyCodeLine{404   \textcolor{keywordflow}{if} (command == NULL)}
\DoxyCodeLine{405   \{}
\DoxyCodeLine{406     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Malloc failed"{}});}
\DoxyCodeLine{407     \textcolor{keywordflow}{return} NULL;}
\DoxyCodeLine{408   \}}
\DoxyCodeLine{409   sprintf(command, \textcolor{stringliteral}{"{}\%s\%s"{}}, AT, SARA\_NETWORK\_INFO\_GET);}
\DoxyCodeLine{410   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(command);}
\DoxyCodeLine{411 }
\DoxyCodeLine{412   \textcolor{keywordtype}{char} ret[128];}
\DoxyCodeLine{413   \textcolor{keywordtype}{int} destIndex = 0;}
\DoxyCodeLine{414   \textcolor{keywordtype}{int} index = 0;}
\DoxyCodeLine{415   \textcolor{keywordtype}{char} c;}
\DoxyCodeLine{416   \textcolor{keywordtype}{char} OK[] = \textcolor{stringliteral}{"{}OK"{}};}
\DoxyCodeLine{417   \textcolor{keywordtype}{int} size = 12;}
\DoxyCodeLine{418   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} timeIn = millis();}
\DoxyCodeLine{419   \textcolor{keywordflow}{while} (millis() -\/ timeIn < 1000)}
\DoxyCodeLine{420   \{}
\DoxyCodeLine{421     \textcolor{keywordflow}{if} (LTEShieldSerial.available())}
\DoxyCodeLine{422     \{}
\DoxyCodeLine{423       c = (char)LTEShieldSerial.read();}
\DoxyCodeLine{424       \textcolor{comment}{// Serial.print(c);}}
\DoxyCodeLine{425       ret[index] = c;}
\DoxyCodeLine{426       \textcolor{comment}{// printToConsole("{}index: \%d\(\backslash\)n"{}, index);}}
\DoxyCodeLine{427       \textcolor{keywordflow}{if} (ret[index -\/ 1] == OK[0] \&\& ret[index] == OK[1])}
\DoxyCodeLine{428       \{}
\DoxyCodeLine{429         \textcolor{keywordflow}{break};}
\DoxyCodeLine{430       \}}
\DoxyCodeLine{431       index++;}
\DoxyCodeLine{432     \}}
\DoxyCodeLine{433   \}}
\DoxyCodeLine{434   }
\DoxyCodeLine{435   ret[++index] = 0;}
\DoxyCodeLine{436   \textcolor{keywordtype}{char} * token = strtok(ret, \textcolor{stringliteral}{"{},\(\backslash\)"{}"{}});}
\DoxyCodeLine{437   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 3; i++)}
\DoxyCodeLine{438   \{}
\DoxyCodeLine{439     token = strtok(NULL, \textcolor{stringliteral}{"{}\(\backslash\)"{},\(\backslash\)"{}"{}});}
\DoxyCodeLine{440   \}}
\DoxyCodeLine{441   }
\DoxyCodeLine{442   strcpy(ip, token);}
\DoxyCodeLine{443   free(command);}
\DoxyCodeLine{444   \textcolor{keywordflow}{return} ip;}
\DoxyCodeLine{445 \}}
\DoxyCodeLine{446 }
\DoxyCodeLine{454 \textcolor{keywordtype}{int} \mbox{\hyperlink{_n_b___r410_m_8h_a1a2a52cca4c1a1964aa1bd6cb7ddd14b}{setCertMQTT}}(\textcolor{keyword}{const} \textcolor{keywordtype}{byte} *cert, \textcolor{keywordtype}{int} size, \textcolor{keywordtype}{int} type, \textcolor{keyword}{const} \textcolor{keywordtype}{char} *name)}
\DoxyCodeLine{455 \{}
\DoxyCodeLine{456   \textcolor{keywordtype}{int} result = 1;}
\DoxyCodeLine{457   \textcolor{keywordtype}{char} *command = NULL;}
\DoxyCodeLine{458   \textcolor{keywordtype}{char} *response = NULL;}
\DoxyCodeLine{459   response = (\textcolor{keywordtype}{char} *)malloc(strlen(SARA\_IMPORT\_CERT\_OK) + 5);}
\DoxyCodeLine{460   \textcolor{keywordflow}{if} (response == NULL)}
\DoxyCodeLine{461   \{}
\DoxyCodeLine{462     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Malloc failed\(\backslash\)n"{}});}
\DoxyCodeLine{463     \textcolor{keywordflow}{return} 2;}
\DoxyCodeLine{464   \}}
\DoxyCodeLine{465   command = (\textcolor{keywordtype}{char} *)malloc((strlen(AT) + strlen(SARA\_IMPORT\_CERT) + strlen(name) + 15));}
\DoxyCodeLine{466   \textcolor{keywordflow}{if} (command == NULL)}
\DoxyCodeLine{467   \{}
\DoxyCodeLine{468     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Malloc failed\(\backslash\)n"{}});}
\DoxyCodeLine{469     free(response);}
\DoxyCodeLine{470     \textcolor{keywordflow}{return} 2;}
\DoxyCodeLine{471   \}}
\DoxyCodeLine{472   sprintf(command, \textcolor{stringliteral}{"{}\%s\%s\%d,\(\backslash\)"{}\%s\(\backslash\)"{},\%d"{}}, AT, SARA\_IMPORT\_CERT, type, name, size);}
\DoxyCodeLine{473   \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Importing certificate: "{}});}
\DoxyCodeLine{474   \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(name);}
\DoxyCodeLine{475   \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{476   \textcolor{comment}{// printToConsole("{}Command: \%s\(\backslash\)n"{}, command);}}
\DoxyCodeLine{477   \textcolor{comment}{//  Empties buffer and transmits the command}}
\DoxyCodeLine{478   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(command);}
\DoxyCodeLine{479 }
\DoxyCodeLine{480   \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(SARA\_IMPORT\_CERT\_READY, 10000))}
\DoxyCodeLine{481   \{}
\DoxyCodeLine{482     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Ready to receive certificate:\(\backslash\)n"{}});}
\DoxyCodeLine{483     \textcolor{comment}{// printToConsole("{}\%s\(\backslash\)n"{},cert);}}
\DoxyCodeLine{484 }
\DoxyCodeLine{485     sprintf(response, \textcolor{stringliteral}{"{}\%s\%d"{}}, SARA\_IMPORT\_CERT\_OK, type);}
\DoxyCodeLine{486 }
\DoxyCodeLine{487     \textcolor{comment}{// Empties buffer and transmits the command}}
\DoxyCodeLine{488     \textcolor{comment}{//transmitCommand(cert);}}
\DoxyCodeLine{489     \textcolor{keywordflow}{while} (LTEShieldSerial.available())}
\DoxyCodeLine{490     \{}
\DoxyCodeLine{491       LTEShieldSerial.read();}
\DoxyCodeLine{492     \}}
\DoxyCodeLine{493     LTEShieldSerial.write(cert, size);}
\DoxyCodeLine{494 }
\DoxyCodeLine{495     \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(response, 10000))}
\DoxyCodeLine{496     \{}
\DoxyCodeLine{497       \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Certificate imported\(\backslash\)n"{}});}
\DoxyCodeLine{498       result = 0;}
\DoxyCodeLine{499     \}}
\DoxyCodeLine{500     \textcolor{keywordflow}{else}}
\DoxyCodeLine{501     \{}
\DoxyCodeLine{502       \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Certificate import failed\(\backslash\)n"{}});}
\DoxyCodeLine{503     \}}
\DoxyCodeLine{504   \}}
\DoxyCodeLine{505   \textcolor{keywordflow}{else}}
\DoxyCodeLine{506   \{}
\DoxyCodeLine{507     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Failed to import certificate -\/ not ready\(\backslash\)n"{}});}
\DoxyCodeLine{508   \}}
\DoxyCodeLine{509   free(command);}
\DoxyCodeLine{510   free(response);}
\DoxyCodeLine{511   \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{512 \}}
\DoxyCodeLine{513 }
\DoxyCodeLine{521 \textcolor{keywordtype}{int} \mbox{\hyperlink{_n_b___r410_m_8h_af2822bc89b1ea866056eb4683255223c}{loadCertMQTT}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} *filename, \textcolor{keywordtype}{int} type, \textcolor{keyword}{const} \textcolor{keywordtype}{char} *name)}
\DoxyCodeLine{522 \{}
\DoxyCodeLine{523   \textcolor{keywordtype}{int} result = 0;}
\DoxyCodeLine{524   File certFile = SPIFFS.open(filename, \textcolor{stringliteral}{"{}r"{}});}
\DoxyCodeLine{525   \textcolor{keywordflow}{if} (!certFile)}
\DoxyCodeLine{526   \{}
\DoxyCodeLine{527     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Failed to open file for reading\(\backslash\)n"{}});}
\DoxyCodeLine{528     \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{529   \}}
\DoxyCodeLine{530   \textcolor{keywordtype}{int} size = certFile.size();}
\DoxyCodeLine{531   \textcolor{keywordtype}{byte} *cert = (\textcolor{keywordtype}{byte} *)malloc(size);}
\DoxyCodeLine{532   \textcolor{keywordflow}{if} (cert == NULL)}
\DoxyCodeLine{533   \{}
\DoxyCodeLine{534     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Malloc failed\(\backslash\)n"{}});}
\DoxyCodeLine{535     \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{536   \}}
\DoxyCodeLine{537   certFile.read(cert, size);}
\DoxyCodeLine{538   certFile.close();}
\DoxyCodeLine{539   result = \mbox{\hyperlink{_n_b___r410_m_8h_a1a2a52cca4c1a1964aa1bd6cb7ddd14b}{setCertMQTT}}(cert, size, type, name);}
\DoxyCodeLine{540   free(cert);}
\DoxyCodeLine{541   \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{542 \}}
\DoxyCodeLine{543 }
\DoxyCodeLine{549 \textcolor{keywordtype}{int} \mbox{\hyperlink{_n_b___r410_m_8h_a8c739d69e197ff1a6d151e981a268641}{setMQTTping}}(\textcolor{keywordtype}{int} timeout)}
\DoxyCodeLine{550 \{}
\DoxyCodeLine{551   \textcolor{keywordtype}{int} result = 1;}
\DoxyCodeLine{552   \textcolor{keywordtype}{char} *command = NULL;}
\DoxyCodeLine{553 }
\DoxyCodeLine{554   command = (\textcolor{keywordtype}{char} *)malloc(strlen(AT) + strlen(SARA\_TIMEOUT) + 5);}
\DoxyCodeLine{555   \textcolor{keywordflow}{if} (command == NULL)}
\DoxyCodeLine{556   \{}
\DoxyCodeLine{557     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Malloc failed\(\backslash\)n"{}});}
\DoxyCodeLine{558     \textcolor{keywordflow}{return} 2;}
\DoxyCodeLine{559   \}}
\DoxyCodeLine{560   sprintf(command, \textcolor{stringliteral}{"{}\%s\%s\%d"{}}, AT, SARA\_TIMEOUT, timeout);}
\DoxyCodeLine{561 }
\DoxyCodeLine{562   \textcolor{comment}{// Empties buffer and transmits the command}}
\DoxyCodeLine{563   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(command);}
\DoxyCodeLine{564 }
\DoxyCodeLine{565   \textcolor{comment}{// Wait for the response}}
\DoxyCodeLine{566   \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(SARA\_TIMEOUT\_SET\_RESPONSE, 10000))}
\DoxyCodeLine{567   \{}
\DoxyCodeLine{568     \textcolor{keywordtype}{char} msgToPrint[50];}
\DoxyCodeLine{569     sprintf(msgToPrint, \textcolor{stringliteral}{"{}MQTT ping interval set to \%d seconds\(\backslash\)n"{}}, timeout);}
\DoxyCodeLine{570     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(msgToPrint);}
\DoxyCodeLine{571     result = 0;}
\DoxyCodeLine{572   \}}
\DoxyCodeLine{573   \textcolor{keywordflow}{else}}
\DoxyCodeLine{574   \{}
\DoxyCodeLine{575     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Error setting MQTT ping timeout\(\backslash\)n"{}});}
\DoxyCodeLine{576   \}}
\DoxyCodeLine{577   free(command);}
\DoxyCodeLine{578   \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{579 \}}
\DoxyCodeLine{580 }
\DoxyCodeLine{586 \textcolor{keywordtype}{int} \mbox{\hyperlink{_n_b___r410_m_8h_a1c3840813cd59414077f5262fdf13244}{setMQTTid}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} *\textcolor{keywordtype}{id})}
\DoxyCodeLine{587 \{}
\DoxyCodeLine{588   \textcolor{keywordtype}{int} result = 1;}
\DoxyCodeLine{589   \textcolor{keywordtype}{char} *command = NULL;}
\DoxyCodeLine{590 }
\DoxyCodeLine{591   command = (\textcolor{keywordtype}{char} *)malloc(strlen(AT) + strlen(SARA\_MQTT\_ID) + strlen(\textcolor{keywordtype}{id}) + 5);}
\DoxyCodeLine{592   \textcolor{keywordflow}{if} (command == NULL)}
\DoxyCodeLine{593   \{}
\DoxyCodeLine{594     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Malloc failed\(\backslash\)n"{}});}
\DoxyCodeLine{595     \textcolor{keywordflow}{return} 2;}
\DoxyCodeLine{596   \}}
\DoxyCodeLine{597   sprintf(command, \textcolor{stringliteral}{"{}\%s\%s\(\backslash\)"{}\%s\(\backslash\)"{}"{}}, AT, SARA\_MQTT\_ID, \textcolor{keywordtype}{id});}
\DoxyCodeLine{598 }
\DoxyCodeLine{599   \textcolor{comment}{// Empties buffer and transmits the command}}
\DoxyCodeLine{600   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(command);}
\DoxyCodeLine{601 }
\DoxyCodeLine{602   \textcolor{comment}{// Wait for the response}}
\DoxyCodeLine{603   \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(SARA\_MQTT\_ID\_SET\_RESPONSE, 10000))}
\DoxyCodeLine{604   \{}
\DoxyCodeLine{605     \textcolor{keywordtype}{char} msgToPrint[50];}
\DoxyCodeLine{606     sprintf(msgToPrint, \textcolor{stringliteral}{"{}MQTT client ID set to \%s\(\backslash\)n"{}}, \textcolor{keywordtype}{id});}
\DoxyCodeLine{607     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(msgToPrint);}
\DoxyCodeLine{608     result = 0;}
\DoxyCodeLine{609   \}}
\DoxyCodeLine{610   \textcolor{keywordflow}{else}}
\DoxyCodeLine{611   \{}
\DoxyCodeLine{612     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Error setting MQTT client ID\(\backslash\)n"{}});}
\DoxyCodeLine{613   \}}
\DoxyCodeLine{614   free(command);}
\DoxyCodeLine{615   \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{616 \}}
\DoxyCodeLine{617 }
\DoxyCodeLine{622 \textcolor{keywordtype}{int} \mbox{\hyperlink{_n_b___r410_m_8h_ae3585e6376929a7f5de0b8243b313e98}{enableMQTTkeepalive}}()}
\DoxyCodeLine{623 \{}
\DoxyCodeLine{624   \textcolor{keywordtype}{int} result = 1;}
\DoxyCodeLine{625   \textcolor{keywordtype}{char} *command = NULL;}
\DoxyCodeLine{626 }
\DoxyCodeLine{627   command = (\textcolor{keywordtype}{char} *)malloc(strlen(AT) + strlen(SARA\_PING) + 5);}
\DoxyCodeLine{628   \textcolor{keywordflow}{if} (command == NULL)}
\DoxyCodeLine{629   \{}
\DoxyCodeLine{630     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Malloc failed\(\backslash\)n"{}});}
\DoxyCodeLine{631     \textcolor{keywordflow}{return} 2;}
\DoxyCodeLine{632   \}}
\DoxyCodeLine{633   sprintf(command, \textcolor{stringliteral}{"{}\%s\%s"{}}, AT, SARA\_PING);}
\DoxyCodeLine{634 }
\DoxyCodeLine{635   \textcolor{comment}{// Empties buffer and transmits the command}}
\DoxyCodeLine{636   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(command);}
\DoxyCodeLine{637 }
\DoxyCodeLine{638   \textcolor{comment}{// Wait for the response}}
\DoxyCodeLine{639   \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(SARA\_PING\_OK, 10000))}
\DoxyCodeLine{640   \{}
\DoxyCodeLine{641     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}MQTT keepalive enabled\(\backslash\)n"{}});}
\DoxyCodeLine{642     result = 0;}
\DoxyCodeLine{643   \}}
\DoxyCodeLine{644   \textcolor{keywordflow}{else}}
\DoxyCodeLine{645   \{}
\DoxyCodeLine{646     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Error enabling MQTT keepalive\(\backslash\)n"{}});}
\DoxyCodeLine{647   \}}
\DoxyCodeLine{648   free(command);}
\DoxyCodeLine{649   \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{650 \}}
\DoxyCodeLine{651 }
\DoxyCodeLine{660 \textcolor{keywordtype}{int} \mbox{\hyperlink{_n_b___r410_m_8h_a92d55d9f690d1e2c337f035700ef5a4e}{publishMessage}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} *topic, \textcolor{keyword}{const} \textcolor{keywordtype}{char} *message, \textcolor{keywordtype}{int} QoS, \textcolor{keywordtype}{int} retain)}
\DoxyCodeLine{661 \{}
\DoxyCodeLine{662   \textcolor{keywordtype}{int} result = 1;}
\DoxyCodeLine{663   \textcolor{keywordtype}{char} *command = NULL;}
\DoxyCodeLine{664 }
\DoxyCodeLine{665   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} SARA\_SEND\_TIMEOUT = 60000;}
\DoxyCodeLine{666 }
\DoxyCodeLine{667   \textcolor{comment}{// printToConsole("{}Allocating memory for command\(\backslash\)n"{});}}
\DoxyCodeLine{668   command = (\textcolor{keywordtype}{char} *)malloc(strlen(AT) + strlen(SARA\_SEND\_MQTT) + strlen(message) + strlen(topic) + 8);}
\DoxyCodeLine{669   \textcolor{keywordflow}{if} (command == NULL)}
\DoxyCodeLine{670   \{}
\DoxyCodeLine{671     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Memory allocation failed\(\backslash\)n"{}});}
\DoxyCodeLine{672     \textcolor{keywordflow}{return} 2;}
\DoxyCodeLine{673   \}}
\DoxyCodeLine{674   \textcolor{comment}{// printToConsole("{}Building command\(\backslash\)n"{});}}
\DoxyCodeLine{675   sprintf(command, \textcolor{stringliteral}{"{}\%s\%s,\%d,\%d,\%s,\%s"{}}, AT, SARA\_SEND\_MQTT, QoS, retain, topic, message);}
\DoxyCodeLine{676 }
\DoxyCodeLine{677   \textcolor{comment}{// printToConsole("{}Command built....Sending\(\backslash\)n"{});}}
\DoxyCodeLine{678 }
\DoxyCodeLine{679   \textcolor{comment}{// Empties buffer and transmits the command}}
\DoxyCodeLine{680   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(command);}
\DoxyCodeLine{681 }
\DoxyCodeLine{682   \textcolor{comment}{// printToConsole("{}Command sent....Waiting for response\(\backslash\)n"{});}}
\DoxyCodeLine{683   \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(SARA\_SEND\_OK, SARA\_SEND\_TIMEOUT))}
\DoxyCodeLine{684   \{}
\DoxyCodeLine{685     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Message sent\(\backslash\)n"{}});}
\DoxyCodeLine{686     result = 0;}
\DoxyCodeLine{687   \}}
\DoxyCodeLine{688   \textcolor{keywordflow}{else}}
\DoxyCodeLine{689   \{}
\DoxyCodeLine{690     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Error sending message\(\backslash\)n"{}});}
\DoxyCodeLine{691   \}}
\DoxyCodeLine{692 }
\DoxyCodeLine{693   free(command);}
\DoxyCodeLine{694   \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{695 \}}
\DoxyCodeLine{696 }
\DoxyCodeLine{701 \textcolor{keywordtype}{int} \mbox{\hyperlink{_n_b___r410_m_8h_ae0c1031eb25784bc3a5ab60e8f3981bf}{loginMQTT}}()}
\DoxyCodeLine{702 \{}
\DoxyCodeLine{703   \textcolor{keywordtype}{int} result = 1;}
\DoxyCodeLine{704   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} SARA\_IP\_CONNECT\_TIMEOUT = 60000;}
\DoxyCodeLine{705 }
\DoxyCodeLine{706   \textcolor{comment}{// Empties buffer and transmits the command}}
\DoxyCodeLine{707   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(SARA\_LOGIN);}
\DoxyCodeLine{708 }
\DoxyCodeLine{709   \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(SARA\_LOGIN\_OK, SARA\_IP\_CONNECT\_TIMEOUT))}
\DoxyCodeLine{710   \{}
\DoxyCodeLine{711     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}MQTT login successfull\(\backslash\)n"{}});}
\DoxyCodeLine{712     result = 0;}
\DoxyCodeLine{713   \}}
\DoxyCodeLine{714   \textcolor{keywordflow}{else}}
\DoxyCodeLine{715   \{}
\DoxyCodeLine{716     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Error logging in to MQTT\(\backslash\)n"{}});}
\DoxyCodeLine{717   \}}
\DoxyCodeLine{718   \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{719 \}}
\DoxyCodeLine{720 }
\DoxyCodeLine{726 \textcolor{keywordtype}{int} \mbox{\hyperlink{_n_b___r410_m_8h_a05ff32195e69fc3d74b5bcd78781c5df}{willconfigMQTT}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} *topic)}
\DoxyCodeLine{727 \{}
\DoxyCodeLine{728   \textcolor{keywordtype}{int} result = 1;}
\DoxyCodeLine{729   \textcolor{keywordtype}{char} *command = NULL;}
\DoxyCodeLine{730   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} SARA\_IP\_CONNECT\_TIMEOUT = 10000;}
\DoxyCodeLine{731 }
\DoxyCodeLine{732   command = (\textcolor{keywordtype}{char} *)malloc(strlen(AT) + strlen(SARA\_WILL\_TOPIC\_MQTT) + strlen(topic) + 10);}
\DoxyCodeLine{733   \textcolor{keywordflow}{if} (command == NULL)}
\DoxyCodeLine{734   \{}
\DoxyCodeLine{735     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Malloc failed"{}});}
\DoxyCodeLine{736     \textcolor{keywordflow}{return} 2;}
\DoxyCodeLine{737   \}}
\DoxyCodeLine{738   sprintf(command, \textcolor{stringliteral}{"{}\%s\%s\%d,\%d,\(\backslash\)"{}\%s\(\backslash\)"{}"{}}, AT, SARA\_WILL\_TOPIC\_MQTT, 0, 0, topic);}
\DoxyCodeLine{739 }
\DoxyCodeLine{740   \textcolor{comment}{// Empties buffer and transmits the command}}
\DoxyCodeLine{741   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(command);}
\DoxyCodeLine{742 }
\DoxyCodeLine{743   \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(SARA\_TOPIC\_OK, SARA\_IP\_CONNECT\_TIMEOUT))}
\DoxyCodeLine{744   \{}
\DoxyCodeLine{745     Serial.println(\textcolor{stringliteral}{"{}Will topic set\(\backslash\)n"{}});}
\DoxyCodeLine{746     result = 0;}
\DoxyCodeLine{747   \}}
\DoxyCodeLine{748   \textcolor{keywordflow}{else}}
\DoxyCodeLine{749   \{}
\DoxyCodeLine{750     Serial.println(\textcolor{stringliteral}{"{}Will topic not set\(\backslash\)n"{}});}
\DoxyCodeLine{751   \}}
\DoxyCodeLine{752 }
\DoxyCodeLine{753   free(command);}
\DoxyCodeLine{754 }
\DoxyCodeLine{755   \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{756 \}}
\DoxyCodeLine{757 }
\DoxyCodeLine{763 \textcolor{keywordtype}{int} \mbox{\hyperlink{_n_b___r410_m_8h_adad4ab35b4d191aaed39087329867277}{willmsgMQTT}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} *message)}
\DoxyCodeLine{764 \{}
\DoxyCodeLine{765   \textcolor{keywordtype}{int} result = 1;}
\DoxyCodeLine{766   \textcolor{keywordtype}{char} *command = NULL;}
\DoxyCodeLine{767 }
\DoxyCodeLine{768   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} SARA\_IP\_CONNECT\_TIMEOUT = 10000;}
\DoxyCodeLine{769 }
\DoxyCodeLine{770   command = (\textcolor{keywordtype}{char} *)malloc(strlen(AT) + strlen(SARA\_WILL\_MESSAGE\_MQTT) + strlen(message) + 10);}
\DoxyCodeLine{771   \textcolor{keywordflow}{if} (command == NULL)}
\DoxyCodeLine{772   \{}
\DoxyCodeLine{773     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Malloc failed\(\backslash\)n"{}});}
\DoxyCodeLine{774     \textcolor{keywordflow}{return} 2;}
\DoxyCodeLine{775   \}}
\DoxyCodeLine{776   sprintf(command, \textcolor{stringliteral}{"{}\%s\%s\(\backslash\)"{}\%s\(\backslash\)"{}"{}}, AT, SARA\_WILL\_MESSAGE\_MQTT, message);}
\DoxyCodeLine{777 }
\DoxyCodeLine{778   \textcolor{comment}{// Empties buffer and transmits the command}}
\DoxyCodeLine{779   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(command);}
\DoxyCodeLine{780 }
\DoxyCodeLine{781   \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(SARA\_MESSAGE\_OK, SARA\_IP\_CONNECT\_TIMEOUT))}
\DoxyCodeLine{782   \{}
\DoxyCodeLine{783     Serial.println(\textcolor{stringliteral}{"{}Will message set\(\backslash\)n"{}});}
\DoxyCodeLine{784     result = 0;}
\DoxyCodeLine{785   \}}
\DoxyCodeLine{786   \textcolor{keywordflow}{else}}
\DoxyCodeLine{787   \{}
\DoxyCodeLine{788     Serial.println(\textcolor{stringliteral}{"{}Will message not set\(\backslash\)n"{}});}
\DoxyCodeLine{789   \}}
\DoxyCodeLine{790   free(command);}
\DoxyCodeLine{791   \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{792 \}}
\DoxyCodeLine{793 }
\DoxyCodeLine{800 \textcolor{keywordtype}{int} \mbox{\hyperlink{_n_b___r410_m_8h_ac0f44c06684338d6571b119289066fce}{setMQTT}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} *host, \textcolor{keywordtype}{int} port)}
\DoxyCodeLine{801 \{}
\DoxyCodeLine{802   \textcolor{keywordtype}{int} result = 1;}
\DoxyCodeLine{803   \textcolor{keywordtype}{char} *command = NULL;}
\DoxyCodeLine{804   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} SARA\_IP\_CONNECT\_TIMEOUT = 10000;}
\DoxyCodeLine{805 }
\DoxyCodeLine{806   command = (\textcolor{keywordtype}{char} *)malloc(\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}) * (strlen(SARA\_CONNECT\_MQTT) + strlen(host) + 15));}
\DoxyCodeLine{807   \textcolor{keywordflow}{if} (command == NULL)}
\DoxyCodeLine{808   \{}
\DoxyCodeLine{809     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Malloc failed\(\backslash\)n"{}});}
\DoxyCodeLine{810     \textcolor{keywordflow}{return} 2;}
\DoxyCodeLine{811   \}}
\DoxyCodeLine{812   \textcolor{comment}{// Create the command}}
\DoxyCodeLine{813   sprintf(command, \textcolor{stringliteral}{"{}AT\%s=\%d,\(\backslash\)"{}\%s\(\backslash\)"{},\%d"{}}, SARA\_CONNECT\_MQTT, 2, host, port);}
\DoxyCodeLine{814   \textcolor{comment}{// Send the command}}
\DoxyCodeLine{815   \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}Setting MQTT hostname \& port\(\backslash\)n"{}});}
\DoxyCodeLine{816 }
\DoxyCodeLine{817   \textcolor{comment}{// Empties buffer and transmits the command}}
\DoxyCodeLine{818   \mbox{\hyperlink{_n_b___r410_m_8h_a301d0294e9c5137ccbc922d3bf7831aa}{transmitCommand}}(command);}
\DoxyCodeLine{819 }
\DoxyCodeLine{820   \textcolor{comment}{// Wait for the response}}
\DoxyCodeLine{821   \textcolor{keywordflow}{if} (\mbox{\hyperlink{_n_b___r410_m_8h_a2540498d294eca76534a8015310df26d}{getResponse}}(SARA\_RESPONSE\_OK, SARA\_IP\_CONNECT\_TIMEOUT))}
\DoxyCodeLine{822   \{}
\DoxyCodeLine{823     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}MQTT hostname \& port set\(\backslash\)n"{}});}
\DoxyCodeLine{824     result = 0;}
\DoxyCodeLine{825   \}}
\DoxyCodeLine{826   \textcolor{keywordflow}{else}}
\DoxyCodeLine{827   \{}
\DoxyCodeLine{828     \mbox{\hyperlink{_n_b___r410_m_8h_a46a4e6cfc8eae8ca667e05b6b55f97c1}{printToConsole}}(\textcolor{stringliteral}{"{}MQTT hostname \& port not set\(\backslash\)n"{}});}
\DoxyCodeLine{829   \}}
\DoxyCodeLine{830 }
\DoxyCodeLine{831   free(command);}
\DoxyCodeLine{832   \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{833 \}}

\end{DoxyCode}
